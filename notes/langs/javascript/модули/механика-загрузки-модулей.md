---
title: "Механика загрузки модулей"
layout: default
parent: "Модули"
---

<h1>Оглавление</h1>
- TOC
{:toc}


# Подключение, момент выполнения кода модуля

## Статический импорт

- К странице можно подключить несколько скриптов как модули (а не обязательно только один)
- Каждый такой скрипт может содержать много импортов, а каждый импорт - еще импорты
- Как выглядит процесс загрузки и выполнения модулей
  - Допустим, к странице подключен один файл как модуль, назовем его "точка входа"
  - Браузер загрузил этот файл
  - Сканирует его на наличие импортов. Цель - быстро найти зависимости
    - Начинает параллельно загружать найденные зависимости
  - После сканирования начинает парсинг файла
    - Пока файл парсится - зависимости грузятся
    - Когда какая-то зависимость загрузилась, браузер так же сканирует и ее на наличие зависимостей, а потом начинает парсить
  - В общем, для каждого модуля браузер выполняет схему "загрузил модуль > просканировал его зависимости > поставил эти зависимости грузиться > начал парсить модуль"
  - Т.о. парсинг происходит параллельно с загрузкой зависимостей, что ускоряет работу
  - Когда все зависимости распарсились, только тогда начинается выполнение "точки входа"
    - Важно! Все импортированные модули **выполняются** *до* выполнения точки входа.
      - Под выполнением понимается выполнение их top-level кода (создание функций, инициализация переменных, выполнение операторов)
- Статический импорт - это "предварительная" загрузка модулей
  - Такие импорты нужно размещать в начале файла на top-level (т.е. не внутри функций или условий)

## Динамический импорт

- Динамический импорт позволяет делать "ленивую загрузку"
  - Т.е. загружать модуль только тогда, когда он действительно нужен. Например, можно запустить его при каком-то условии. Условие не выполняется - модуль не загружается > не тратится лишний трафик и неиспользуемый модуль не потребляет память
- Динамический импорт можно размещать в любом месте файла, в т.ч. внутри условий, функций
- import(foobar) возвращает промис
  - Промис резолвится, когда модуль **выполнился**. Т.е. не просто загрузился, а именно загрузился + распарсился + выполнился его top-level код (создались функции, инициализировались переменные, выполнились операторы)
- Динамически импортированный модуль кэшируется
  - Повторный вызов import(foobar) вернет уже загруженный модуль
  - Загруженный модуль - это просто объект, в свойствах которого находятся его экспорты. Обращаться к ним можно через этот объект



# Загрузка и выгрузка модуля из памяти

- Каждый модуль загружается в память единожды
  - Т.е. если один и тот же модуль импортируется в нескольких других модулях, то в памяти он будет представлен единственным объектом
- Выгрузка - на усмотрение браузера
  - Статически импортированные модули обычно не выгружаются, остаются в памяти, пока открыта страница
  - Динамически импортированные модули могут быть выгружены, если не осталось ссылок на модуль или его экспорты



# Клиенты модуля разделяют все его экспорты

- Если модуль используют несколько клиентов, то все они имеют ссылку на один и тот же объект модуля
  - Это значит, что все экспорты тоже для них одни и те же
    - Например, если модуль экспортирует переменную count и какой-то клиент увеличил ее значение, то и другие клиенты будут работать с измененным значением



# Tree-shaking

- Tree-shaking это фишка бандлеров. Браузер этого не делает
- Tree-shaking это удаление неиспользуемых сущностей из финальной сборки
  - Что удаляется
    - Экспорты, которые не были импортированы
    - Функции \ классы \ сущности, которые не используются внутри своего модуля

